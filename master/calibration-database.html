
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calibration &#8212; iris_pipeline v0.4.dev</title>
    <link rel="stylesheet" href="_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <script type="text/javascript" src="_static/sidebar.js"></script>
    <script type="text/javascript" src="_static/copybutton.js"></script>
    <link rel="shortcut icon" href="_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Available algorithms" href="available-steps.html" />
    <link rel="prev" title="IRIS Data Reduction System design" href="design.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="index.html"><span id="logotext1">iris_pipeline</span><span id="logotext2"></span><span id="logotext3">:docs</span></a>
  <ul>
    
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="genindex.html">Index</a></li>
    <li><a title="Module Index" href="py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li class="right">
	<a href="available-steps.html" title="Available algorithms">
	  next &raquo;
	</a>
      </li>
      <li class="right">
	<a href="design.html" title="IRIS Data Reduction System design">
	  &laquo; previous
	</a>
	 |
      </li>
      <li>
	<a href="index.html">iris_pipeline v0.4.dev</a>
	 &#187;
      </li>
      
      <li>Calibration</li> 
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            


  <div class="section" id="calibration">
<h1>Calibration<a class="headerlink" href="#calibration" title="Permalink to this headline">¶</a></h1>
<div class="section" id="calibration-files">
<h2>Calibration files<a class="headerlink" href="#calibration-files" title="Permalink to this headline">¶</a></h2>
<p>Auxiliary data used in DRP algorithms are called calibration data. This includes both on-sky data (that is not of the astronomical target itself), daytime calibration frames, and other sub-component metadata. Metadata is non-image information that will typically come from the header of raw FITS files, or from IRIS, and/or the adaptive optics system via the observatory telemetry service. The NFIRAOS Science Calibration Unit (NSCU) will include a calibration system that will facilitate the taking of
daytime calibration frames, such as arc lamp spectra, white light flat field images, and pinhole grids for measuring distortion.
The following table summarizes the required calibration files necessary for the Data Reduction Software.</p>
<p>Notes about the table: Note: * = SPEC only, PTG = pointing, D-Map = Distortion Map, Env = Environmental, DTC = Daytime calibration, NTC = Nightime calibration.</p>
<table class="colwidths-given docutils align-default" id="id1">
<caption><span class="caption-text">Calibration frames</span><a class="headerlink" href="#id1" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 33%" />
<col style="width: 22%" />
<col style="width: 22%" />
<col style="width: 22%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Reference Type</p></th>
<th class="head"><p>Source</p></th>
<th class="head"><p>Algorithms</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Atm. Dispersion Residual</p></td>
<td><p>Metadata</p></td>
<td><p>IRIS ADC</p></td>
<td><p>Atmospheric Correction</p></td>
</tr>
<tr class="row-odd"><td><p>Arc lamp spectra*</p></td>
<td><p>CAL (2D)</p></td>
<td><p>IRIS DTC (NSCU)</p></td>
<td><p>Wavelength solution</p></td>
</tr>
<tr class="row-even"><td><p>Bad pixel map</p></td>
<td><p>CAL (2D)</p></td>
<td><p>IRIS DTC</p></td>
<td><p>Correction of detector artifacts</p></td>
</tr>
<tr class="row-odd"><td><p>Dark Frame</p></td>
<td><p>CAL (2D)</p></td>
<td><p>IRIS DTC and NTC</p></td>
<td><p>Dark subtraction</p></td>
</tr>
<tr class="row-even"><td><p>Env metadata</p></td>
<td><p>Metadata</p></td>
<td><p>ESW, FITS header</p></td>
<td><p>All</p></td>
</tr>
<tr class="row-odd"><td><p>Fiber image</p></td>
<td><p>CAL (2D, 3D)</p></td>
<td><p>IRIS DTC (NSCU)</p></td>
<td><p>PSF Calibration</p></td>
</tr>
<tr class="row-even"><td><p>Flux calibration star</p></td>
<td><p>CAL (2D, 3D)</p></td>
<td><p>IRIS On-sky</p></td>
<td><p>Extract Star, Remove Absorption Lines</p></td>
</tr>
<tr class="row-odd"><td><p>Instrument config</p></td>
<td><p>Metadata</p></td>
<td><p>ESW, FITS header</p></td>
<td><p>All</p></td>
</tr>
<tr class="row-even"><td><p>Lenslet scan*</p></td>
<td><p>Rect Matrix CAL (2D)</p></td>
<td><p>IRIS DTC (NSCU)</p></td>
<td><p>Spectral Extraction</p></td>
</tr>
<tr class="row-odd"><td><p>NFIRAOS config</p></td>
<td><p>Metadata</p></td>
<td><p>ESW, FITS header</p></td>
<td><p>All</p></td>
</tr>
<tr class="row-even"><td><p>Pinhole Grid (D-Map)</p></td>
<td><p>CAL (2D)</p></td>
<td><p>IRIS DTC (NSCU)</p></td>
<td><p>Field distortion correction</p></td>
</tr>
<tr class="row-odd"><td><p>PSF metadata</p></td>
<td><p>Metadata</p></td>
<td><p>ESW, FITS header</p></td>
<td><p>PSF calibration</p></td>
</tr>
<tr class="row-even"><td><p>PSF star</p></td>
<td><p>CAL (2D, 3D)</p></td>
<td><p>IRIS on-sky</p></td>
<td><p>PSF calibration</p></td>
</tr>
<tr class="row-odd"><td><p>Sky frame</p></td>
<td><p>CAL (2D, 3D)</p></td>
<td><p>IRIS on-sky</p></td>
<td><p>Sky-subtraction</p></td>
</tr>
<tr class="row-even"><td><p>Telescope config PTG</p></td>
<td><p>Metadata</p></td>
<td><p>ESW, FITS header</p></td>
<td><p>All</p></td>
</tr>
</tbody>
</table>
<table class="colwidths-given docutils align-default" id="id2">
<caption><span class="caption-text">Real time Calibration frames</span><a class="headerlink" href="#id2" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 33%" />
<col style="width: 22%" />
<col style="width: 22%" />
<col style="width: 22%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Reference Type</p></th>
<th class="head"><p>Source</p></th>
<th class="head"><p>Algorithms</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Atm. Dispersion Residual</p></td>
<td><p>Metadata</p></td>
<td><p>IRIS ADC</p></td>
<td><p>Atmospheric Correction</p></td>
</tr>
<tr class="row-odd"><td><p>Arc lamp spectra*</p></td>
<td><p>CAL (2D)</p></td>
<td><p>IRIS DTC (NSCU)</p></td>
<td><p>Wavelength solution</p></td>
</tr>
<tr class="row-even"><td><p>Bad pixel map</p></td>
<td><p>CAL (2D)</p></td>
<td><p>IRIS DTC</p></td>
<td><p>Correction of detector artifacts</p></td>
</tr>
<tr class="row-odd"><td><p>Dark Frame</p></td>
<td><p>CAL (2D)</p></td>
<td><p>IRIS DTC and NTC</p></td>
<td><p>Dark subtraction</p></td>
</tr>
<tr class="row-even"><td><p>Env metadata</p></td>
<td><p>Metadata</p></td>
<td><p>ESW, FITS header</p></td>
<td><p>All</p></td>
</tr>
<tr class="row-odd"><td><p>Instrument config</p></td>
<td><p>Metadata</p></td>
<td><p>ESW, FITS header</p></td>
<td><p>All</p></td>
</tr>
<tr class="row-even"><td><p>NFIRAOS config</p></td>
<td><p>Metadata</p></td>
<td><p>ESW, FITS header</p></td>
<td><p>All</p></td>
</tr>
<tr class="row-odd"><td><p>Sky frame</p></td>
<td><p>CAL (2D, 3D)</p></td>
<td><p>IRIS on-sky</p></td>
<td><p>Sky-subtraction</p></td>
</tr>
<tr class="row-even"><td><p>Telescope config PTG</p></td>
<td><p>Metadata</p></td>
<td><p>ESW, FITS header</p></td>
<td><p>All</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="access-calibration-files-via-the-calibration-reference-data-system-crds">
<h2>Access calibration files via the Calibration Reference Data System (CRDS)<a class="headerlink" href="#access-calibration-files-via-the-calibration-reference-data-system-crds" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="https://hst-crds.stsci.edu/static/users_guide/overview.html">Calibration Reference Data System
(CRDS)</a>
is a set of tools developed by Space Telescope to organize and retrieve
calibration reference files, e.g. flat frames, dark frames, for JWST and
HST. When <code class="docutils literal notranslate"><span class="pre">stpipe</span></code> is executing a pipeline, it can automatically
connect to the JWST CRDS server and get the right flat based on the
metadata in the header of the data FITS files. The logic necessary to
choose the right file is encoded in text files. Those configuration
files and the actual calibration FITS files are also cached locally so
that the CRDS client library works even without any connection to a
central server.</p>
<p>We have created a CRDS cache folder in the Github repository
<a class="reference external" href="https://github.com/oirlab/tmt-crds-cache">https://github.com/oirlab/tmt-crds-cache</a>,
this includes in the <code class="docutils literal notranslate"><span class="pre">mappings/tmt</span></code>
<a class="reference external" href="https://github.com/oirlab/tmt-crds-cache/tree/master/mappings/tmt">folder</a>
the metadata for IRIS and the rules to choose the right flat-field and dark-current
frame, for now there are only dummy rules but this can be easily
customized querying the metadata in the input file.</p>
<p>Currently we do not have any CRDS server running, but the users can
download the CRDS cache locally and use it anyway, see the <a class="reference external" href="getting-started">Getting
started</a> documentation.</p>
<p>Also, the CRDS client library needs to have minimal knowledge about
metadata for TMT, therefore we maintain a fork of that library which
simply adds a submodule dedicated to IRIS, <a class="reference external" href="https://github.com/oirlab/tmt-crds">https://github.com/oirlab/tmt-crds</a>, it is quite
easy to upgrade this to newer releases of CRDS by Space Telescope.</p>
<p>If TMT decided to use CRDS as their Data Management System, it would
leverage the extensive set of tools and documentation available and
would not require modifications to <code class="docutils literal notranslate"><span class="pre">stpipe</span></code>; otherwise, we will
implement support for the DMS API into (our own fork of) <code class="docutils literal notranslate"><span class="pre">stpipe</span></code>.</p>
<div class="section" id="structure-of-the-files-in-crds">
<h3>Structure of the files in CRDS<a class="headerlink" href="#structure-of-the-files-in-crds" title="Permalink to this headline">¶</a></h3>
<p>The complete documentation of CRDS is available <a class="reference external" href="https://jwst-crds.stsci.edu/static/users_guide/index.html">from Space Telescope</a>,
in this section we will provide a quick overview of the structure of the files in the CRDS cache we use for TMT/IRIS.</p>
<p>The files are all text files and have a hierarchical structure and the root is a <code class="docutils literal notranslate"><span class="pre">.pmap</span></code> file,
in our case it is <a class="reference external" href="https://github.com/oirlab/tmt-crds-cache/blob/master/mappings/tmt/tmt_0001.pmap">tmt_0001.pmap</a>,
this file defines the observatory and it is used to switch between different versions of the instrument model.
In fact when we define the environment variables for CRDS we specify <code class="docutils literal notranslate"><span class="pre">CRDS_CONTEXT</span></code> to be the filename of
the <code class="docutils literal notranslate"><span class="pre">.pmap</span></code> file we want to use. This makes it very
easy to switch back and forth between different versions of the calibration files.</p>
<p>At the bottom of the <code class="docutils literal notranslate"><span class="pre">.pmap</span></code> file we point to all the different instruments of the current observatory and
the specific version of their definition files. For now we only have <a class="reference external" href="https://github.com/oirlab/tmt-crds-cache/blob/master/mappings/tmt/tmt_iris_0003.imap">tmt_iris_0003.imap</a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">.imap</span></code> file defines what kind of calibration files are available in CRDS. For example we can
have DARK, FLAT and MASK, each pointing to a reference file <code class="docutils literal notranslate"><span class="pre">.rmap</span></code>.
The <code class="docutils literal notranslate"><span class="pre">.rmap</span></code> files are the most important because they actually encode the rules that the CRDS client uses
to choose which actual FITS calibration file should be used based on the metadata available in the
FITS header of the data file.
First in the <code class="docutils literal notranslate"><span class="pre">parkey</span></code> key of the header it defines what fields of the input file header should be taken
into consideration, for example the detector,  the subarray configuration and the datetime of the observation.
Then it encodes different rules to match for each value of the keys in <code class="docutils literal notranslate"><span class="pre">parkey</span></code> the filename of the
FITS calibration file that should be used. Those files are available as well in the CRDS cache inside
the <a class="reference external" href="https://github.com/oirlab/tmt-crds-cache/tree/master/references/tmt/iris">references folder</a>.</p>
<p>Calibration FITS files are quite large, they are therefore stored on Github using <code class="docutils literal notranslate"><span class="pre">Git</span> <span class="pre">LFS</span></code> and are
automatically downloaded when a user clones the repository.
In production, scientists would just interface with the CRDS server and the local CRDS cache will be
automatically created and keep updated by synchronizing with the server. A Github repository with
the CRDS Cache is just useful during the development phase.</p>
</div>
<div class="section" id="retrieve-files-from-the-crds">
<h3>Retrieve files from the CRDS<a class="headerlink" href="#retrieve-files-from-the-crds" title="Permalink to this headline">¶</a></h3>
<p>Within <code class="docutils literal notranslate"><span class="pre">iris_pipeline</span></code>, all the subclasses of <code class="xref py py-class docutils literal notranslate"><span class="pre">jwst.Step</span></code> can recall a configuration file using the
<code class="xref py py-obj docutils literal notranslate"><span class="pre">self.get_reference_file</span></code> method and passing the input model (whose metadata will be used to find the right calibration file)
and the type of calibration file requested.</p>
<p>Or we could create a temporary <code class="xref py py-class docutils literal notranslate"><span class="pre">jwst.Step</span></code> instance just to get the filename, for example:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">raw_science_frame</span> <span class="o">=</span> <span class="n">iris_pipeline</span><span class="o">.</span><span class="n">datamodels</span><span class="o">.</span><span class="n">IRISImageModel</span><span class="p">(</span><span class="s2">&quot;raw_science_frame_sci.fits&quot;</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">full_dark_filename</span> <span class="o">=</span> <span class="n">jwst</span><span class="o">.</span><span class="n">stpipe</span><span class="o">.</span><span class="n">Step</span><span class="p">()</span><span class="o">.</span><span class="n">get_reference_file</span><span class="p">(</span><span class="n">raw_science_frame</span><span class="p">,</span> <span class="s2">&quot;dark&quot;</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">full_dark_filename</span><span class="p">)</span>
<span class="s1">&#39;~/crds_cache/references/tmt/iris/tmt_iris_dark_0001.fits&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="ingest-new-calibration-files-into-crds">
<h3>Ingest new calibration files into CRDS<a class="headerlink" href="#ingest-new-calibration-files-into-crds" title="Permalink to this headline">¶</a></h3>
<p>Users that would like to use a custom calibration file just occasionally can override them using options
to the calibration pipeline, see for example the <code class="docutils literal notranslate"><span class="pre">override_flat</span></code> configuration option to the flat-fielding
pipeline step.</p>
<p>Instead, developers that would like to add calibration files to the CRDS itself, and optionally provide a
pull request to the CRDS cache repository on Github, should use the <code class="docutils literal notranslate"><span class="pre">crds</span></code> command line tool.</p>
<p>1) Make sure that the calibration file has all the necessary headers defined,
if you are creating a file using <code class="docutils literal notranslate"><span class="pre">iris_pipeline</span></code> this is automatically satisfied, for example using
<code class="xref py py-class docutils literal notranslate"><span class="pre">IRISImageModel</span></code>.</p>
<ol class="arabic" start="2">
<li><p>Add any additional header key, typically <code class="docutils literal notranslate"><span class="pre">USEAFTER</span></code>:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">USEAFTER</span><span class="o">=</span> <span class="s1">&#39;2019-06-01 00:00:00&#39;</span>
</pre></div>
</div>
</li>
<li><p>Create the new <code class="docutils literal notranslate"><span class="pre">.rmap</span></code> file:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">crds</span> <span class="n">refactor2</span> <span class="n">insert_reference</span> <span class="o">--</span><span class="n">verbose</span> <span class="o">--</span><span class="n">old</span><span class="o">-</span><span class="n">rmap</span> \
    <span class="o">~/</span><span class="n">crds_cache</span><span class="o">/</span><span class="n">mappings</span><span class="o">/</span><span class="n">tmt</span><span class="o">/</span><span class="n">tmt_iris_flat_0003</span><span class="o">.</span><span class="n">rmap</span> <span class="o">--</span><span class="n">new</span><span class="o">-</span><span class="n">rmap</span> \
    <span class="o">~/</span><span class="n">crds_cache</span><span class="o">/</span><span class="n">mappings</span><span class="o">/</span><span class="n">tmt</span><span class="o">/</span><span class="n">tmt_iris_flat_0004</span><span class="o">.</span><span class="n">rmap</span> \
    <span class="o">--</span><span class="n">instruments</span> <span class="n">IRIS</span> \
    <span class="o">--</span><span class="n">references</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">new</span><span class="o">/</span><span class="n">reference</span><span class="o">/</span><span class="n">file</span><span class="o">.</span><span class="n">fits</span>
</pre></div>
</div>
</li>
<li><p>Modify the <code class="docutils literal notranslate"><span class="pre">.imap</span></code> to point to this new file for the reference file we are working with</p></li>
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">update_checksums.sh</span></code> in the <code class="docutils literal notranslate"><span class="pre">mappings/tmt</span></code> folder to automatically update the checksums</p></li>
<li><p>Add the FITS calibration file in the CRDS cache <code class="docutils literal notranslate"><span class="pre">references/tmt/iris/</span></code> folder</p></li>
<li><p>Optionally add all new files and modified files to the repository and send a Pull Request to the <code class="docutils literal notranslate"><span class="pre">tmt-crds-cache</span></code> repository</p></li>
</ol>
</div>
</div>
</div>



            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3>Releases</h3>
<ul>
</ul>
<h3>In Development</h3>
<ul>
  <li><a href="calibration-database.html">master</a></li>
</ul>


<h3>Page Contents</h3>
<ul>
<li><a class="reference internal" href="#">Calibration</a><ul>
<li><a class="reference internal" href="#calibration-files">Calibration files</a></li>
<li><a class="reference internal" href="#access-calibration-files-via-the-calibration-reference-data-system-crds">Access calibration files via the Calibration Reference Data System (CRDS)</a><ul>
<li><a class="reference internal" href="#structure-of-the-files-in-crds">Structure of the files in CRDS</a></li>
<li><a class="reference internal" href="#retrieve-files-from-the-crds">Retrieve files from the CRDS</a></li>
<li><a class="reference internal" href="#ingest-new-calibration-files-into-crds">Ingest new calibration files into CRDS</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right">
    <a href="https://github.com/oirlab/iris_pipeline/tree/master/docs/calibration-database.rst">Edit This Page on Github</a> &nbsp;
    <a href="_sources/calibration-database.rst.txt"
       rel="nofollow">Page Source</a> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2020, Andrea Zonca, Arun Surya.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 3.2.1. &nbsp;
    Last built 09 Oct 2020. <br/>
  </p>
</footer>
  </body>
</html>